import radiance.ui;
import std.io;

struct State(
    count: int,
    name: string,
);

fn[throws] set_bindings(count_text: string, name_text: string) {
    let updates = [
        ui.DataUpdate(key = "count_text", value = count_text),
        ui.DataUpdate(key = "name_text", value = name_text),
    ];
    ui.update_data(ref(updates));
}

pub fn[throws] init() -> box<State> {
    let xml = "<ui version=\"1\"><vbox id=\"root\"><label id=\"title\" text=\"Radiance + p7 UI demo\" /><hbox id=\"row\"><label id=\"count_label\" text=\"{count_text}\" /><button id=\"inc\" text=\"+\" on_click=\"demo.increment\" /><button id=\"reset\" text=\"reset\" on_click=\"demo.reset\" /></hbox><text_input id=\"name\" text=\"{name_text}\" on_change=\"demo.name_changed\" /><label id=\"hello\" text=\"Hello, {name_text}\" /></vbox></ui>";

    ui.set_ui(xml);
    set_bindings("count=0", "world");

    io.println("p7 UI demo initialized");

    box(State(0, "world"))
}

pub fn[throws] process_message(state: box<State>, msg: ui.Message) {
    io.println(msg.kind);
    if msg.kind == "demo.increment" {
        state.count = state.count + 1;
        set_bindings("count={state.count}", state.name);
    }

    if msg.kind == "demo.reset" {
        state.count = 0;
        state.name = "world";
        set_bindings("count=0", state.name);
    }

    if msg.kind == "demo.name_changed" {
        let updates = [ui.DataUpdate(key = "name_text", value = msg.payload)];
        ui.update_data(ref(updates));
    }
}
